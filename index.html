<!doctype html>
<html>
<head>
    <title>Many Points with leaflet WebGL</title>
    <meta charset="utf-8">

    <style>
        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            background: rgb(14, 21, 30);
        }

        #map {
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: #333;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="lnlt"></div>
</body>
<!--<link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css" />-->
<!--<script src="bower_components/leaflet/dist/leaflet.js"></script>-->
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<script src="glify_line_weight.js"></script>
<script src="https://unpkg.com/pbf@3.0.5/dist/pbf.js"></script>
<script src="https://unpkg.com/geobuf@3.0.1/dist/geobuf.js"></script>
<script>
  var map = L.map('map')
          .setView([42.25, -93], 7);

  // L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-background,$fff[difference],$fff[@23],$fff[hsl-saturation@20],toner-lines[destination-in])/{z}/{x}/{y}.png")
  //   //L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/{z}/{x}/{y}.png")
  //   .addTo(map);
  L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png").addTo(map);
let rvrData;


function drawRvr(src){


    rvr = L.glify.lines({
        map: map,
        latitudeKey: 1,
        longitudeKey: 0,
        // weight:.11,
        color:     function getColor(i,feature) {
            d = feature.properties.link_id;
            return d > 1000000 ? L.glify.color.fromHex('#800026') :
                d > 500000 ? L.glify.color.fromHex('#BD0026') :
                    d > 200000 ? L.glify.color.fromHex('#E31A1C') :
                        d > 100000 ? L.glify.color.fromHex('#FC4E2A') :
                            d > 50000 ? L.glify.color.fromHex('#FD8D3C') :
                                d > 20000 ? L.glify.color.fromHex('#FEB24C') :
                                    d > 10000 ? L.glify.color.fromHex('#FED976') :
                                        L.glify.color.fromHex('#FFEDA0');
        },
        opacity:1,
        click: function (e, feature) {
            L.popup()
                .setLatLng(e.latlng)
                .setContent("You clicked on " + feature.properties.link_id)
                .openOn(map);

            console.log(feature);
            console.log(e);
        },
        data: src,
    });
    return rvr;
}


  function getData() {
  var myRequest = new Request('network_90m.pbf');
  fetch(myRequest).then(function(response) {
      return response.arrayBuffer();
  }).then(function(buffer) {
      var geojson = geobuf.decode(new Pbf(buffer));
      drawRvr(geojson);
  })
  }
  getData()
</script>
</html>
